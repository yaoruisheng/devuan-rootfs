name: Build Debian ARM Root Filesystems (Matrix Parallel)

on:
  workflow_dispatch:

jobs:
  # ====================================================================
  # JOB 1: å¹¶è¡Œæ„å»ºæ‰€æœ‰æ¶æ„ RootFS
  # ====================================================================
  build_rootfs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            qemu_binary: qemu-aarch64-static
          - arch: armhf
            qemu_binary: qemu-arm-static
          - arch: armel
            qemu_binary: qemu-arm-static

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Install dependencies (debootstrap + QEMU)
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap tar curl wget qemu-user-static

      - name: 3. Build Debian ${{ matrix.arch }} rootfs (Stage 1)
        env:
          ROOTFS_DIR: ${{ github.workspace }}/debian_${{ matrix.arch }}
        run: |
          mkdir -p "$ROOTFS_DIR"

          # Stage 1: ä¸‹è½½å’Œæå–åŒ…
          sudo debootstrap --verbose --arch=${{ matrix.arch }} --variant=minbase \
            --include=sysvinit-core,sysv-rc,libpam-elogind,dropbear,nano,wget,curl,procps,iproute2,dbus-x11,chrony \
            --foreign \
            stable "$ROOTFS_DIR" http://deb.debian.org/debian

          # DNS
          echo -e "nameserver 8.8.8.8\nnameserver 8.8.4.4" | sudo tee "$ROOTFS_DIR/etc/resolv.conf"

          # Sources.list
          echo "deb http://mirrors.huaweicloud.com/debian stable main contrib non-free non-free-firmware" \
            | sudo tee "$ROOTFS_DIR/etc/apt/sources.list"

          # ç¦ç”¨ systemd ç³»åˆ—åŒ…
          cat <<EOF | sudo tee "$ROOTFS_DIR/etc/apt/preferences.d/00-nosystemd"
Package: systemd*
Pin: version *
Pin-Priority: -1

Package: libsystemd*
Pin: version *
Pin-Priority: -1

Package: udev
Pin: version *
Pin-Priority: -1
EOF

          # ä¿®å¤ debootstrap çš„å° bug
          sudo sed -i '/Cannot install into target/c\:' "$ROOTFS_DIR/debootstrap/debootstrap"

      - name: 4. Run Stage 2 inside chroot (via QEMU) & Configure System âš™ï¸
        env:
          ROOTFS_DIR: ${{ github.workspace }}/debian_${{ matrix.arch }}
        run: |
          sudo cp /usr/bin/${{ matrix.qemu_binary }} "$ROOTFS_DIR/usr/bin/"

          # æŒ‚è½½å¿…éœ€çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
          sudo mount -t proc /proc "$ROOTFS_DIR/proc"
          sudo mount --rbind /sys "$ROOTFS_DIR/sys"
          sudo mount --rbind /dev "$ROOTFS_DIR/dev"

          # Stage 2: å®ŒæˆåŒ…é…ç½®
          sudo chroot "$ROOTFS_DIR" /debootstrap/debootstrap --second-stage
          
          # ------------------------------------------------------------------
          # ğŸŒŸ æ–°å¢ï¼šç³»ç»Ÿé…ç½®
          # ------------------------------------------------------------------
          echo "--- Running custom configurations inside chroot ---"
          
          # 1. è®¾ç½® root åˆå§‹å¯†ç ä¸º 'debian888'
          sudo chroot "$ROOTFS_DIR" sh -c 'echo "root:debian888" | chpasswd'
          
          # 2. æ·»åŠ è‡ªå®šä¹‰ç³»ç»Ÿç»„ (GIDs 3001-3005)
          sudo chroot "$ROOTFS_DIR" sh -c '
            groupadd -g 3001 aid_net_bt_admin
            groupadd -g 3002 aid_net_bt
            groupadd -g 3003 aid_inet
            groupadd -g 3004 aid_inet_raw
            groupadd -g 3005 aid_inet_admin
          '
          
          # 3. ä¿®æ”¹ _apt å’Œ _chrony ç”¨æˆ·çš„ç»„è®¾ç½®
          # æ³¨æ„ï¼š-g è®¾ç½®ä¸»ç»„ï¼Œ-G è®¾ç½®è¾…åŠ©ç»„ (è¦†ç›–ç°æœ‰è¾…åŠ©ç»„)
          sudo chroot "$ROOTFS_DIR" sh -c '
            usermod -G nogroup -g aid_inet _apt
            usermod -G _chrony -g aid_inet _chrony
          '
          
          echo "--- Custom configurations finished ---"
          # ------------------------------------------------------------------

          # å¸è½½è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
          sudo umount -lf "$ROOTFS_DIR/proc" || true
          sudo umount -lf "$ROOTFS_DIR/sys" || true
          sudo umount -lf "$ROOTFS_DIR/dev" || true

      - name: 5. Cleanup & Pack RootFS
        id: tar
        env:
          ROOTFS_DIR: ${{ github.workspace }}/debian_${{ matrix.arch }}
        run: |
          # æ¸…ç† QEMU äºŒè¿›åˆ¶æ–‡ä»¶
          sudo rm "$ROOTFS_DIR/usr/bin/${{ matrix.qemu_binary }}"

          # æ‰“åŒ…
          TARBALL_NAME=debian-${{ matrix.arch }}-rootfs.tar.gz
          sudo tar -czf "$TARBALL_NAME" -C "$ROOTFS_DIR" .

          echo "TARBALL_NAME=$TARBALL_NAME" >> $GITHUB_OUTPUT

      - name: 6. Upload RootFS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-rootfs-${{ matrix.arch }}
          path: ${{ steps.tar.outputs.TARBALL_NAME }}

  # ====================================================================
  # JOB 2: åˆ›å»º Releaseï¼ˆæ”¶é›†æ‰€æœ‰ Artifactï¼‰
  # ====================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build_rootfs
    permissions:
      contents: write

    steps:
      - name: 1. Download all artifacts
        uses: actions/download-artifact@v4
        with:
          # ä¸å†™ nameï¼Œä¸‹è½½ build_rootfs Job äº§ç”Ÿçš„æ‰€æœ‰ Artifacts
          path: ./release_artifacts

      - name: 2. Flatten artifact directories
        run: |
          find ./release_artifacts -name "*.tar.gz" -exec mv {} ./release_artifacts/ \;
          find ./release_artifacts -type d -empty -delete
          ls -lh ./release_artifacts

      - name: 3. Generate release tag
        id: date
        run: echo "RELEASE_TAG=v$(date +'%Y.%m.%d').${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: 4. Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.date.outputs.RELEASE_TAG }}
          name: Debian ARM RootFS Build ${{ steps.date.outputs.RELEASE_TAG }}
          body: |
            ## ğŸš€ è‡ªåŠ¨ç”Ÿæˆçš„ Debian ARM Root Filesystem

            åŒ…å«ä»¥ä¸‹æ¶æ„çš„æœ€å°åŒ– RootFSï¼š

            - ARM64ï¼ˆaarch64ï¼‰
            - ARMHFï¼ˆarmv7 ç¡¬æµ®ç‚¹ï¼‰
            - ARMELï¼ˆarmv5/armv6 è½¯æµ®ç‚¹ï¼‰

            **ç³»ç»Ÿé…ç½®è¦ç‚¹:**
            - **Root åˆå§‹å¯†ç ï¼šdebian888** ğŸš¨
            - é»˜è®¤ sysvinit
            - å®Œå…¨ç¦ç”¨ systemd
            - minbase ç²¾ç®€æ„å»º
            - qemu-user-static æ”¯æŒè·¨æ¶æ„æ„å»º
            - **è‡ªå®šä¹‰ç»„é…ç½®**ï¼šæ·»åŠ äº† GIDs 3001-3005 çš„ç³»ç»Ÿç»„ï¼Œå¹¶è°ƒæ•´äº† `_apt` å’Œ `_chrony` ç”¨æˆ·çš„ç»„ã€‚
          files: ./release_artifacts/*.tar.gz
